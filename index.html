<script>
// ===== STARFIELD =====
(function() {
    var starfield = document.getElementById('starfield');
    for (var i = 0; i < 100; i++) {
        var star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        starfield.appendChild(star);
    }
})();

// ===== VOICE GREETING =====
var hasPlayedGreeting = false;

function playGreeting() {
    if (hasPlayedGreeting) return;
    hasPlayedGreeting = true;
    
    document.getElementById('greetingBtn').classList.add('hidden');
    document.getElementById('voiceIndicator').classList.add('active');
    
    fetch('https://pure-dispatch-backend-v4.vercel.app/api/greeting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('Backend returned ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        if (!data.success || !data.audio) {
            throw new Error('Invalid response from backend');
        }
        
        var audio = new Audio(data.audio);
        audio.volume = 0.85;
        audio.playbackRate = 0.92;
        
        audio.onended = function() {
            document.getElementById('voiceIndicator').classList.remove('active');
        };
        
        audio.onerror = function() {
            console.error('ElevenLabs audio playback failed, falling back to Web Speech');
            playWebSpeechFallback();
        };
        
        audio.play().catch(function(err) {
            console.error('ElevenLabs play failed:', err);
            playWebSpeechFallback();
        });
    })
    .catch(function(error) {
        console.error('ElevenLabs backend error:', error);
        playWebSpeechFallback();
    });
}

function playWebSpeechFallback() {
    window.speechSynthesis.cancel();
    
    var utterance = new SpeechSynthesisUtterance("Hello Driver. I'm Pure. Ready to find you some loads?");
    utterance.volume = 0.85;
    utterance.rate = 0.95;
    utterance.pitch = 1.0;
    utterance.lang = 'en-US';
    
    var voices = window.speechSynthesis.getVoices();
    for (var i = 0; i < voices.length; i++) {
        if (voices[i].name.indexOf('Female') > -1 || voices[i].name.indexOf('Samantha') > -1) {
            utterance.voice = voices[i];
            break;
        }
    }
    
    utterance.onend = function() {
        document.getElementById('voiceIndicator').classList.remove('active');
    };
    
    utterance.onerror = function() {
        document.getElementById('voiceIndicator').classList.remove('active');
    };
    
    window.speechSynthesis.speak(utterance);
}

document.getElementById('greetingBtn').onclick = playGreeting;

document.addEventListener('click', function firstClick() {
    setTimeout(playGreeting, 300);
    document.removeEventListener('click', firstClick);
}, { once: true });

// ===== FORM SUBMISSION =====
var form = document.getElementById('waitlistForm');
var submitBtn = document.getElementById('submitBtn');
var formStatus = document.getElementById('formStatus');

function showStatus(message, type) {
    formStatus.textContent = message;
    formStatus.className = type;
    formStatus.style.display = 'block';
}

form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    var name = document.getElementById('name').value.trim();
    var email = document.getElementById('email').value.trim();
    
    if (!name) {
        showStatus('‚ùå Please enter your name.', 'error');
        document.getElementById('name').focus();
        return;
    }
    
    if (!email || !email.includes('@') || !email.includes('.')) {
        showStatus('‚ùå Please enter a valid email address.', 'error');
        document.getElementById('email').focus();
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    formStatus.className = '';
    formStatus.style.display = 'none';
    
    var data = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: data,
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(function(response) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        
        if (response.ok) {
            showStatus('‚úÖ Success! You\'re on the waitlist. Check your email for confirmation.', 'success');
            form.reset();
        } else {
            return response.json().then(function(data) {
                if (data.errors) {
                    showStatus('‚ùå ' + data.errors.map(function(e) { return e.message; }).join(', '), 'error');
                } else {
                    showStatus('‚ùå Something went wrong. Please try again.', 'error');
                }
            });
        }
    })
    .catch(function(error) {
        console.error('AJAX failed, falling back to native submit:', error);
        form.submit();
    });
});

// ===== PAYMENT HANDLING - FIXED TO USE LOOKUP KEYS =====
const BACKEND_URL = 'https://pure-dispatch-stripe-backend.vercel.app';

var currentPeriods = {
    founder: 'monthly',
    standard: 'monthly'
};

window.selectPeriod = function(button, tier, period) {
    var container = button.parentElement;
    var buttons = container.querySelectorAll('.period-btn');
    buttons.forEach(function(btn) {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    currentPeriods[tier] = period;
    
    if (tier === 'founder') {
        var priceEl = document.getElementById('founder-price');
        var savingsEl = document.getElementById('founder-savings');
        var btnEl = document.getElementById('founder-btn');
        
        if (period === 'monthly') {
            priceEl.innerHTML = '$50<span>/month</span>';
            savingsEl.textContent = 'Pay monthly or save $300/year!';
            btnEl.textContent = 'Get Started - $50/mo';
            btnEl.setAttribute('onclick', "handlePayment('early_founder_monthly', this)");
        } else {
            priceEl.innerHTML = '$300<span>/year</span>';
            savingsEl.textContent = 'Save $300/year vs monthly!';
            btnEl.textContent = 'Get Started - $300/yr';
            btnEl.setAttribute('onclick', "handlePayment('early_founder_annual', this)");
        }
    } else {
        var priceEl = document.getElementById('standard-price');
        var savingsEl = document.getElementById('standard-savings');
        var btnEl = document.getElementById('standard-btn');
        
        if (period === 'monthly') {
            priceEl.innerHTML = '$99.99<span>/month</span>';
            savingsEl.textContent = 'Pay monthly or save $400/year!';
            btnEl.textContent = 'Get Started - $99.99/mo';
            btnEl.setAttribute('onclick', "handlePayment('standard_monthly', this)");
        } else {
            priceEl.innerHTML = '$799.99<span>/year</span>';
            savingsEl.textContent = 'Save $400/year vs monthly!';
            btnEl.textContent = 'Get Started - $799.99/yr';
            btnEl.setAttribute('onclick', "handlePayment('standard_annual', this)");
        }
    }
};

window.handlePayment = function(lookupKey, button) {
    console.log('üîµ Starting payment with lookup_key:', lookupKey);
    
    button.disabled = true;
    button.classList.add('loading');
    var originalText = button.textContent;
    button.textContent = 'Processing...';
    
    fetch(BACKEND_URL + '/api/create-checkout-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lookup_key: lookupKey
        })
    })
    .then(function(response) {
        console.log('üì° Backend response status:', response.status);
        if (!response.ok) {
            return response.text().then(function(text) {
                console.error('‚ùå Backend error:', text);
                throw new Error('Payment failed: ' + text);
            });
        }
        return response.json();
    })
    .then(function(data) {
        console.log('‚úÖ Backend response:', data);
        if (data.url) {
            console.log('üöÄ Redirecting to:', data.url);
            window.location.href = data.url;
        } else {
            throw new Error('No checkout URL received');
        }
    })
    .catch(function(error) {
        console.error('üí• Payment error:', error);
        button.disabled = false;
        button.classList.remove('loading');
        button.textContent = originalText;
        alert('Unable to process payment. Please try again or contact support.');
    });
};
</script>

